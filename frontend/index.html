<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Manager</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0d1b2e;
    --navy-light: #1a3a5c;
    --teal: #00c9a7;
    --teal-dim: #00c9a720;
    --amber: #ffb830;
    --red: #ff4757;
    --red-dim: #ff475720;
    --bg: #07111f;
    --surface: #0f1e30;
    --surface2: #162740;
    --border: #1e3550;
    --text: #c8d8e8;
    --text-muted: #5e7a94;
    --white: #ffffff;
    --radius: 10px;
    --shadow: 0 4px 24px rgba(0,0,0,0.5);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
  }

  /* Sidebar */
  .sidebar {
    width: 240px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0; left: 0; bottom: 0;
    z-index: 100;
  }
  .sidebar-logo {
    padding: 24px 20px;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-logo h1 {
    font-family: 'Space Mono', monospace;
    font-size: 17px;
    color: var(--teal);
    letter-spacing: -0.5px;
  }
  .sidebar-logo span {
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'Space Mono', monospace;
  }
  .nav-section {
    padding: 12px 12px 4px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text-muted);
    font-weight: 600;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    margin: 2px 8px;
    border-radius: 8px;
    cursor: pointer;
    color: var(--text-muted);
    font-size: 14px;
    font-weight: 500;
    transition: all 0.15s;
    border: none;
    background: none;
    width: calc(100% - 16px);
    text-align: left;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--teal-dim); color: var(--teal); }
  .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }
  .badge {
    margin-left: auto;
    background: var(--red);
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 10px;
    font-family: 'Space Mono', monospace;
  }

  /* Main */
  .main {
    margin-left: 240px;
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  .topbar {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 28px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
  }
  .topbar h2 { font-size: 17px; font-weight: 600; color: var(--white); }
  .topbar-actions { display: flex; gap: 10px; align-items: center; }

  .content { padding: 24px 28px; flex: 1; }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
  }
  .card-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 16px;
  }

  /* Stats grid */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }
  .stat-card.teal::before { background: var(--teal); }
  .stat-card.amber::before { background: var(--amber); }
  .stat-card.blue::before { background: #4e9eff; }
  .stat-card.red::before { background: var(--red); }
  .stat-label { font-size: 12px; color: var(--text-muted); font-weight: 500; margin-bottom: 8px; }
  .stat-value { font-family: 'Space Mono', monospace; font-size: 26px; font-weight: 700; color: var(--white); }
  .stat-icon { position: absolute; right: 16px; top: 16px; font-size: 28px; opacity: 0.2; }

  /* Buttons */
  .btn {
    padding: 8px 16px;
    border-radius: 7px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
  }
  .btn-primary { background: var(--teal); color: #000; }
  .btn-primary:hover { background: #00e0ba; }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--teal); color: var(--teal); }
  .btn-danger { background: var(--red-dim); color: var(--red); border: 1px solid #ff475740; }
  .btn-danger:hover { background: var(--red); color: white; }
  .btn-excel { background: #1a6e3c20; color: #4caf76; border: 1px solid #4caf7640; }
  .btn-excel:hover { background: #1a6e3c; color: white; }
  .btn-sm { padding: 5px 10px; font-size: 12px; }
  .btn-icon { background: none; border: 1px solid var(--border); color: var(--text-muted); width: 32px; height: 32px; padding: 0; justify-content: center; }
  .btn-icon:hover { border-color: var(--teal); color: var(--teal); }

  /* Table */
  .table-wrap { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th {
    background: var(--surface2);
    color: var(--text-muted);
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
    padding: 12px 14px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    white-space: nowrap;
  }
  td { padding: 12px 14px; border-bottom: 1px solid var(--border); color: var(--text); }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }
  .mono { font-family: 'Space Mono', monospace; font-size: 12px; }

  /* Pills */
  .pill {
    display: inline-flex;
    align-items: center;
    padding: 3px 9px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
  }
  .pill-green { background: #00c9a720; color: var(--teal); }
  .pill-red { background: var(--red-dim); color: var(--red); }
  .pill-amber { background: #ffb83020; color: var(--amber); }
  .pill-blue { background: #4e9eff20; color: #4e9eff; }
  .pill-entrada { background: #00c9a720; color: var(--teal); }
  .pill-salida { background: var(--red-dim); color: var(--red); }
  .pill-ajuste { background: #ffb83020; color: var(--amber); }
  .pill-transferencia { background: #4e9eff20; color: #4e9eff; }

  /* Forms */
  .form-group { margin-bottom: 16px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  input, select, textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 9px 12px;
    color: var(--text);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color 0.15s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--teal); }
  input[type="number"] { font-family: 'Space Mono', monospace; }
  select option { background: var(--surface2); }
  textarea { resize: vertical; min-height: 70px; }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 520px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    transform: translateY(20px);
    transition: transform 0.2s;
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .modal-header h3 { font-size: 16px; font-weight: 600; color: var(--white); }
  .modal-body { padding: 20px 24px; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }
  .btn-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px; padding: 4px; line-height: 1; }
  .btn-close:hover { color: var(--white); }

  /* Filters */
  .filters { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
  .filters input, .filters select { width: auto; flex: 1; min-width: 160px; }
  .search-box { position: relative; flex: 2; }
  .search-box input { padding-left: 34px; }
  .search-box::before { content: 'üîç'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 13px; }

  /* Alert banner */
  .alert-banner {
    background: #ff475710;
    border: 1px solid #ff475740;
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--red);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  /* Tabs */
  .tabs { display: flex; gap: 4px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: -1px; }
  .tab {
    padding: 8px 16px;
    border-radius: 7px 7px 0 0;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    border: 1px solid transparent;
    border-bottom: none;
    background: none;
    transition: all 0.15s;
    margin-bottom: -1px;
  }
  .tab:hover { color: var(--text); }
  .tab.active { background: var(--surface); border-color: var(--border); border-bottom-color: var(--surface); color: var(--teal); }

  /* Bar chart simple */
  .bar-chart { display: flex; flex-direction: column; gap: 10px; }
  .bar-row { display: flex; align-items: center; gap: 12px; }
  .bar-label { width: 130px; font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .bar-track { flex: 1; background: var(--surface2); border-radius: 4px; height: 8px; overflow: hidden; }
  .bar-fill { height: 100%; background: var(--teal); border-radius: 4px; transition: width 0.6s ease; }
  .bar-value { width: 60px; text-align: right; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--text); }

  /* Sections */
  .section { display: none; }
  .section.active { display: block; }

  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .mt-16 { margin-top: 16px; }

  /* Reportes */
  .report-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .report-card h3 { font-size: 15px; color: var(--white); }
  .report-card p { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
  .report-icon { font-size: 36px; }
  .reports-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }

  /* Toast */
  .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
  .toast {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 13px;
    color: var(--text);
    box-shadow: var(--shadow);
    animation: slideIn 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 260px;
    max-width: 360px;
  }
  .toast.success { border-left: 3px solid var(--teal); }
  .toast.error { border-left: 3px solid var(--red); }
  @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* Responsive */
  @media (max-width: 900px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .grid-2 { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; }
    .sidebar { width: 200px; }
    .main { margin-left: 200px; }
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  .empty-state div { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  .cantidad-input { display: flex; align-items: center; gap: 8px; }
  .cantidad-input button {
    width: 32px; height: 32px; border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface2); color: var(--text);
    cursor: pointer; font-size: 16px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .cantidad-input button:hover { border-color: var(--teal); color: var(--teal); }
  .cantidad-input input { text-align: center; }

  .tipo-btns { display: flex; gap: 8px; }
  .tipo-btn {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 2px solid var(--border);
    background: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.15s;
    font-family: 'DM Sans', sans-serif;
    text-align: center;
  }
  .tipo-btn.selected.entrada { border-color: var(--teal); background: var(--teal-dim); color: var(--teal); }
  .tipo-btn.selected.salida { border-color: var(--red); background: var(--red-dim); color: var(--red); }
  .tipo-btn.selected.ajuste { border-color: var(--amber); background: #ffb83020; color: var(--amber); }
  .tipo-btn.selected.transferencia { border-color: #4e9eff; background: #4e9eff20; color: #4e9eff; }

  .current-stock {
    background: var(--surface2);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .current-stock span { font-size: 12px; color: var(--text-muted); }
  .current-stock strong { font-family: 'Space Mono', monospace; font-size: 18px; color: var(--white); }

  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
  .dot-green { background: var(--teal); }
  .dot-red { background: var(--red); }
</style>
</head>
<body>

<!-- Sidebar -->
<nav class="sidebar">
  <div class="sidebar-logo">
    <h1>üì¶ STOCK</h1>
    <span>MANAGER v1.0</span>
  </div>
  <div style="flex:1; overflow-y:auto; padding: 8px 0;">
    <div class="nav-section">Principal</div>
    <button class="nav-item active" onclick="showSection('dashboard')">
      <span class="icon">üìä</span> Dashboard
    </button>
    <button class="nav-item" onclick="showSection('stock')">
      <span class="icon">üì¶</span> Stock
    </button>
    <button class="nav-item" onclick="showSection('alertas')">
      <span class="icon">üîî</span> Alertas
      <span class="badge" id="badge-alertas" style="display:none">0</span>
    </button>
    <div class="nav-section">Gesti√≥n</div>
    <button class="nav-item" onclick="showSection('productos')">
      <span class="icon">üè∑</span> Productos
    </button>
    <button class="nav-item" onclick="showSection('ubicaciones')">
      <span class="icon">üìç</span> Ubicaciones
    </button>
    <button class="nav-item" onclick="showSection('categorias')">
      <span class="icon">üóÇ</span> Categor√≠as
    </button>
    <div class="nav-section">Historial</div>
    <button class="nav-item" onclick="showSection('movimientos')">
      <span class="icon">üîÑ</span> Movimientos
    </button>
    <div class="nav-section">Exportar</div>
    <button class="nav-item" onclick="showSection('reportes')">
      <span class="icon">üì•</span> Reportes Excel
    </button>
  </div>
</nav>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <h2 id="page-title">Dashboard</h2>
    <div class="topbar-actions" id="topbar-actions"></div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div id="sec-dashboard" class="section active">
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card teal"><div class="stat-label">Total Productos</div><div class="stat-value" id="stat-productos">‚Äî</div><div class="stat-icon">üè∑</div></div>
        <div class="stat-card blue"><div class="stat-label">Ubicaciones</div><div class="stat-value" id="stat-ubicaciones">‚Äî</div><div class="stat-icon">üìç</div></div>
        <div class="stat-card amber"><div class="stat-label">Unidades Totales</div><div class="stat-value" id="stat-unidades">‚Äî</div><div class="stat-icon">üì¶</div></div>
        <div class="stat-card red"><div class="stat-label">Stock Bajo M√≠nimo</div><div class="stat-value" id="stat-alertas">‚Äî</div><div class="stat-icon">‚ö†</div></div>
      </div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title">Stock por Ubicaci√≥n</div>
          <div class="bar-chart" id="chart-ubicaciones"><p style="color:var(--text-muted);font-size:13px">Cargando...</p></div>
        </div>
        <div class="card">
          <div class="card-title">Valor Total del Inventario</div>
          <div style="display:flex;align-items:center;justify-content:center;height:120px;flex-direction:column;gap:8px">
            <div style="font-size:36px;font-family:'Space Mono',monospace;color:var(--teal)" id="stat-valor">‚Äî</div>
            <div style="font-size:12px;color:var(--text-muted)">Basado en precio de costo</div>
          </div>
          <div class="card-title mt-16">Movimientos √∫ltimos 30 d√≠as</div>
          <div id="chart-movimientos" class="bar-chart"></div>
        </div>
      </div>
    </div>

    <!-- STOCK -->
    <div id="sec-stock" class="section">
      <div class="filters">
        <div class="search-box"><input type="text" placeholder="Buscar producto..." id="stock-search" oninput="loadStock()"></div>
        <select id="stock-filter-ub" onchange="loadStock()"><option value="">Todas las ubicaciones</option></select>
        <label style="display:flex;align-items:center;gap:6px;color:var(--text-muted);font-size:13px;text-transform:none;letter-spacing:0">
          <input type="checkbox" id="stock-bajo" onchange="loadStock()" style="width:auto"> Solo bajo m√≠nimo
        </label>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr>
            <th>C√≥digo</th><th>Producto</th><th>Categor√≠a</th><th>Ubicaci√≥n</th>
            <th>Cantidad</th><th>M√≠nimo</th><th>Estado</th><th>Acciones</th>
          </tr></thead>
          <tbody id="stock-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ALERTAS -->
    <div id="sec-alertas" class="section">
      <div class="alert-banner" id="alertas-banner" style="display:none">
        <span>‚ö†</span><span id="alertas-banner-text"></span>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>C√≥digo</th><th>Producto</th><th>Ubicaci√≥n</th><th>Stock Actual</th><th>M√≠nimo</th><th>Faltante</th><th>Acci√≥n</th></tr></thead>
          <tbody id="alertas-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- PRODUCTOS -->
    <div id="sec-productos" class="section">
      <div class="filters">
        <div class="search-box"><input type="text" placeholder="Buscar..." id="prod-search" oninput="loadProductos()"></div>
        <select id="prod-filter-cat" onchange="loadProductos()"><option value="">Todas las categor√≠as</option></select>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>C√≥digo</th><th>Nombre</th><th>Categor√≠a</th><th>Unidad</th><th>Precio Costo</th><th>Stock Total</th><th>Acciones</th></tr></thead>
          <tbody id="prod-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- UBICACIONES -->
    <div id="sec-ubicaciones" class="section">
      <div class="table-wrap">
        <table>
          <thead><tr><th>Nombre</th><th>Descripci√≥n</th><th>Productos</th><th>Stock Total</th><th>Acciones</th></tr></thead>
          <tbody id="ub-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- CATEGORIAS -->
    <div id="sec-categorias" class="section">
      <div class="table-wrap">
        <table>
          <thead><tr><th>Nombre</th><th>Productos</th><th>Acciones</th></tr></thead>
          <tbody id="cat-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- MOVIMIENTOS -->
    <div id="sec-movimientos" class="section">
      <div class="filters">
        <select id="mov-tipo" onchange="loadMovimientos()">
          <option value="">Todos los tipos</option>
          <option value="entrada">Entrada</option>
          <option value="salida">Salida</option>
          <option value="ajuste">Ajuste</option>
          <option value="transferencia">Transferencia</option>
        </select>
        <select id="mov-ub" onchange="loadMovimientos()"><option value="">Todas las ubicaciones</option></select>
        <input type="date" id="mov-desde" onchange="loadMovimientos()">
        <input type="date" id="mov-hasta" onchange="loadMovimientos()">
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Fecha</th><th>Tipo</th><th>Producto</th><th>Ubicaci√≥n</th><th>Cantidad</th><th>Anterior</th><th>Posterior</th><th>Motivo</th><th>Usuario</th></tr></thead>
          <tbody id="mov-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- REPORTES -->
    <div id="sec-reportes" class="section">
      <div class="reports-grid">
        <div class="report-card">
          <div class="report-icon">üìã</div>
          <h3>Stock General</h3>
          <p>Reporte completo de stock de todos los productos en todas las ubicaciones.</p>
          <div class="form-group" style="margin-bottom:0">
            <label>Filtrar por ubicaci√≥n (opcional)</label>
            <select id="rep-ub"></select>
          </div>
          <button class="btn btn-excel" onclick="downloadReporte('stock-general')">‚¨á Descargar Excel</button>
        </div>
        <div class="report-card">
          <div class="report-icon">üìç</div>
          <h3>Stock por Ubicaci√≥n</h3>
          <p>Excel con una hoja por cada ubicaci√≥n mostrando el detalle de productos y cantidades.</p>
          <button class="btn btn-excel" onclick="downloadReporte('por-ubicacion')">‚¨á Descargar Excel</button>
        </div>
        <div class="report-card">
          <div class="report-icon">üîÑ</div>
          <h3>Movimientos</h3>
          <p>Historial de movimientos de stock en un per√≠odo seleccionado.</p>
          <div class="form-row" style="margin-bottom:0">
            <div class="form-group" style="margin-bottom:0">
              <label>Desde</label>
              <input type="date" id="rep-desde">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Hasta</label>
              <input type="date" id="rep-hasta">
            </div>
          </div>
          <button class="btn btn-excel" onclick="downloadReporte('movimientos')">‚¨á Descargar Excel</button>
        </div>
        <div class="report-card">
          <div class="report-icon">‚ö†</div>
          <h3>Alertas ‚Äî Bajo M√≠nimo</h3>
          <p>Productos que se encuentran por debajo del stock m√≠nimo configurado, con costo de reposici√≥n.</p>
          <button class="btn btn-excel" onclick="downloadReporte('bajo-minimo')">‚¨á Descargar Excel</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<!-- MODALES -->

<!-- Modal Ajuste Stock -->
<div class="modal-overlay" id="modal-ajuste">
  <div class="modal">
    <div class="modal-header">
      <h3>Ajustar Stock</h3>
      <button class="btn-close" onclick="closeModal('modal-ajuste')">√ó</button>
    </div>
    <div class="modal-body">
      <div class="current-stock">
        <div><span>Producto</span><br><strong id="adj-producto-nombre">‚Äî</strong></div>
        <div style="text-align:right"><span>Stock actual</span><br><strong id="adj-stock-actual">‚Äî</strong></div>
      </div>
      <div class="form-group">
        <label>Tipo de movimiento</label>
        <div class="tipo-btns">
          <button class="tipo-btn entrada" onclick="selectTipo('entrada')">‚ûï Entrada</button>
          <button class="tipo-btn salida" onclick="selectTipo('salida')">‚ûñ Salida</button>
          <button class="tipo-btn ajuste" onclick="selectTipo('ajuste')">‚öñ Ajuste</button>
          <button class="tipo-btn transferencia" onclick="selectTipo('transferencia')">üîÑ Transfer</button>
        </div>
      </div>
      <div id="adj-transfer-row" class="form-group" style="display:none">
        <label>Ubicaci√≥n destino</label>
        <select id="adj-ub-destino"></select>
      </div>
      <div class="form-group">
        <label>Cantidad</label>
        <div class="cantidad-input">
          <button onclick="changeQty(-1)">‚àí</button>
          <input type="number" id="adj-cantidad" value="1" min="0.001" step="0.001">
          <button onclick="changeQty(1)">+</button>
        </div>
      </div>
      <div class="form-group">
        <label>Motivo / Observaci√≥n</label>
        <textarea id="adj-motivo" placeholder="Descripci√≥n del movimiento..."></textarea>
      </div>
      <input type="hidden" id="adj-producto-id">
      <input type="hidden" id="adj-ubicacion-id">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-ajuste')">Cancelar</button>
      <button class="btn btn-primary" onclick="submitAjuste()">Confirmar</button>
    </div>
  </div>
</div>

<!-- Modal Producto -->
<div class="modal-overlay" id="modal-producto">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modal-prod-title">Nuevo Producto</h3>
      <button class="btn-close" onclick="closeModal('modal-producto')">√ó</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="prod-id">
      <div class="form-row">
        <div class="form-group">
          <label>C√≥digo *</label>
          <input type="text" id="prod-codigo" placeholder="EJ: ELEC-001">
        </div>
        <div class="form-group">
          <label>Unidad de medida</label>
          <input type="text" id="prod-unidad" placeholder="unidad, kg, litro...">
        </div>
      </div>
      <div class="form-group">
        <label>Nombre *</label>
        <input type="text" id="prod-nombre" placeholder="Nombre del producto">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Categor√≠a</label>
          <select id="prod-cat"></select>
        </div>
        <div class="form-group">
          <label>Precio de costo</label>
          <input type="number" id="prod-precio" placeholder="0.00" step="0.01" min="0">
        </div>
      </div>
      <div class="form-group">
        <label>Descripci√≥n</label>
        <textarea id="prod-desc" placeholder="Descripci√≥n opcional..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-producto')">Cancelar</button>
      <button class="btn btn-primary" onclick="submitProducto()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Ubicacion -->
<div class="modal-overlay" id="modal-ubicacion">
  <div class="modal" style="width:400px">
    <div class="modal-header">
      <h3 id="modal-ub-title">Nueva Ubicaci√≥n</h3>
      <button class="btn-close" onclick="closeModal('modal-ubicacion')">√ó</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="ub-id">
      <div class="form-group">
        <label>Nombre *</label>
        <input type="text" id="ub-nombre" placeholder="Ej: Almac√©n Principal">
      </div>
      <div class="form-group">
        <label>Descripci√≥n</label>
        <textarea id="ub-desc" placeholder="Descripci√≥n opcional..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-ubicacion')">Cancelar</button>
      <button class="btn btn-primary" onclick="submitUbicacion()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Categor√≠a -->
<div class="modal-overlay" id="modal-categoria">
  <div class="modal" style="width:360px">
    <div class="modal-header">
      <h3 id="modal-cat-title">Nueva Categor√≠a</h3>
      <button class="btn-close" onclick="closeModal('modal-categoria')">√ó</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="cat-id">
      <div class="form-group">
        <label>Nombre *</label>
        <input type="text" id="cat-nombre" placeholder="Ej: Electr√≥nica">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-categoria')">Cancelar</button>
      <button class="btn btn-primary" onclick="submitCategoria()">Guardar</button>
    </div>
  </div>
</div>

<script>
const API = 'https://stockapp-production-5e18.up.railway.app/api';
let currentSection = 'dashboard';
let tipoAjusteSeleccionado = 'entrada';
let ubicaciones = [], productos = [], categorias = [];

// ===================== UTILS =====================
function fmt(n) { return new Intl.NumberFormat('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(n || 0); }
function fmtMoney(n) { return '$' + new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2 }).format(n || 0); }

async function apiFetch(path, opts = {}) {
  try {
    const r = await fetch(API + path, {
      headers: { 'Content-Type': 'application/json' },
      ...opts
    });
    if (!r.ok) {
      const err = await r.json().catch(() => ({ error: 'Error del servidor' }));
      throw new Error(err.error || 'Error del servidor');
    }
    return await r.json();
  } catch (e) {
    toast(e.message, 'error');
    throw e;
  }
}

function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span>${type === 'success' ? '‚úì' : '‚úó'}</span><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function showSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
  document.getElementById('sec-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(b => {
    if (b.getAttribute('onclick') === `showSection('${name}')`) b.classList.add('active');
  });
  currentSection = name;
  const titles = { dashboard:'Dashboard', stock:'Stock', alertas:'Alertas de Stock', productos:'Productos',
    ubicaciones:'Ubicaciones', categorias:'Categor√≠as', movimientos:'Movimientos', reportes:'Reportes Excel' };
  document.getElementById('page-title').textContent = titles[name] || name;
  renderTopbarActions(name);
  if (name === 'dashboard') loadDashboard();
  else if (name === 'stock') loadStock();
  else if (name === 'alertas') loadAlertas();
  else if (name === 'productos') loadProductos();
  else if (name === 'ubicaciones') loadUbicaciones();
  else if (name === 'categorias') loadCategorias();
  else if (name === 'movimientos') loadMovimientos();
  else if (name === 'reportes') loadReporteOptions();
}

function renderTopbarActions(section) {
  const el = document.getElementById('topbar-actions');
  const map = {
    productos: `<button class="btn btn-primary" onclick="openModalProducto()">+ Nuevo Producto</button>`,
    ubicaciones: `<button class="btn btn-primary" onclick="openModalUbicacion()">+ Nueva Ubicaci√≥n</button>`,
    categorias: `<button class="btn btn-primary" onclick="openModalCategoria()">+ Nueva Categor√≠a</button>`,
    stock: `<button class="btn btn-secondary" onclick="showSection('reportes')">üì• Exportar</button>`,
  };
  el.innerHTML = map[section] || '';
}

// ===================== DASHBOARD =====================
async function loadDashboard() {
  try {
    const d = await apiFetch('/dashboard');
    document.getElementById('stat-productos').textContent = d.resumen.total_productos;
    document.getElementById('stat-ubicaciones').textContent = d.resumen.total_ubicaciones;
    document.getElementById('stat-unidades').textContent = fmt(d.resumen.unidades_totales);
    document.getElementById('stat-alertas').textContent = d.alertas_stock_bajo;
    document.getElementById('stat-valor').textContent = fmtMoney(d.resumen.valor_total_stock);

    // Badge
    const badge = document.getElementById('badge-alertas');
    if (d.alertas_stock_bajo > 0) { badge.style.display=''; badge.textContent = d.alertas_stock_bajo; }

    // Gr√°fico ubicaciones
    const maxStock = Math.max(...d.stock_por_ubicacion.map(u => parseFloat(u.stock_total)));
    document.getElementById('chart-ubicaciones').innerHTML = d.stock_por_ubicacion.map(u => `
      <div class="bar-row">
        <div class="bar-label" title="${u.nombre}">${u.nombre}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${maxStock > 0 ? (parseFloat(u.stock_total)/maxStock*100) : 0}%"></div></div>
        <div class="bar-value">${fmt(u.stock_total)}</div>
      </div>`).join('');

    // Gr√°fico movimientos
    const colores = { entrada: 'var(--teal)', salida: 'var(--red)', ajuste: 'var(--amber)', transferencia: '#4e9eff' };
    const maxMov = Math.max(...d.movimientos_30_dias.map(m => parseFloat(m.suma)));
    document.getElementById('chart-movimientos').innerHTML = d.movimientos_30_dias.map(m => `
      <div class="bar-row">
        <div class="bar-label">${m.tipo.charAt(0).toUpperCase()+m.tipo.slice(1)} (${m.total})</div>
        <div class="bar-track"><div class="bar-fill" style="width:${maxMov > 0 ? (parseFloat(m.suma)/maxMov*100) : 0}%;background:${colores[m.tipo]||'var(--teal)'}"></div></div>
        <div class="bar-value">${fmt(m.suma)}</div>
      </div>`).join('') || '<p style="color:var(--text-muted);font-size:13px">Sin movimientos recientes</p>';
  } catch (e) {}
}

// ===================== STOCK =====================
async function loadStock() {
  const search = document.getElementById('stock-search').value;
  const ub = document.getElementById('stock-filter-ub').value;
  const bajo = document.getElementById('stock-bajo').checked;

  let params = new URLSearchParams();
  if (ub) params.append('ubicacion_id', ub);
  if (bajo) params.append('bajo_minimo', 'true');

  try {
    let data = await apiFetch('/stock?' + params);
    if (search) {
      const s = search.toLowerCase();
      data = data.filter(r => r.producto.toLowerCase().includes(s) || r.codigo.toLowerCase().includes(s));
    }

    const tbody = document.getElementById('stock-tbody');
    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div>üì¶</div><p>No se encontraron registros</p></div></td></tr>`;
      return;
    }
    tbody.innerHTML = data.map(r => {
      const ok = r.cantidad > r.cantidad_minima;
      const estado = ok
        ? `<span class="pill pill-green"><span class="dot dot-green"></span>OK</span>`
        : `<span class="pill pill-red"><span class="dot dot-red"></span>Bajo m√≠nimo</span>`;
      return `<tr>
        <td class="mono">${r.codigo}</td>
        <td><strong>${r.producto}</strong></td>
        <td>${r.categoria || '‚Äî'}</td>
        <td>${r.ubicacion}</td>
        <td class="mono">${fmt(r.cantidad)} <span style="font-size:11px;color:var(--text-muted)">${r.unidad_medida}</span></td>
        <td class="mono">${fmt(r.cantidad_minima)}</td>
        <td>${estado}</td>
        <td>
          <button class="btn btn-primary btn-sm" onclick='openAjuste(${JSON.stringify({id:r.producto_id,nombre:r.producto,codigo:r.codigo})}, ${r.ubicacion_id}, "${r.ubicacion}", ${r.cantidad})'>
            ¬± Ajustar
          </button>
        </td>
      </tr>`;
    }).join('');
  } catch (e) {}
}

// ===================== ALERTAS =====================
async function loadAlertas() {
  try {
    const data = await apiFetch('/stock?bajo_minimo=true');
    const banner = document.getElementById('alertas-banner');
    if (data.length) {
      banner.style.display = 'flex';
      document.getElementById('alertas-banner-text').textContent = `${data.length} producto(s) con stock por debajo del m√≠nimo configurado.`;
    }
    const tbody = document.getElementById('alertas-tbody');
    if (!data.length) {
      tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div>‚úÖ</div><p>Todo el stock est√° en niveles correctos</p></div></td></tr>`;
      return;
    }
    tbody.innerHTML = data.map(r => `<tr>
      <td class="mono">${r.codigo}</td>
      <td><strong>${r.producto}</strong></td>
      <td>${r.ubicacion}</td>
      <td class="mono" style="color:var(--red)">${fmt(r.cantidad)}</td>
      <td class="mono">${fmt(r.cantidad_minima)}</td>
      <td class="mono" style="color:var(--amber)">+${fmt(r.cantidad_minima - r.cantidad)}</td>
      <td><button class="btn btn-primary btn-sm" onclick='openAjuste(${JSON.stringify({id:r.producto_id,nombre:r.producto,codigo:r.codigo})},${r.ubicacion_id},"${r.ubicacion}",${r.cantidad})'>¬± Ajustar</button></td>
    </tr>`).join('');
  } catch (e) {}
}

// ===================== AJUSTE MODAL =====================
function openAjuste(producto, ubicacion_id, ubicacion_nombre, cantidad_actual) {
  document.getElementById('adj-producto-id').value = producto.id;
  document.getElementById('adj-ubicacion-id').value = ubicacion_id;
  document.getElementById('adj-producto-nombre').textContent = `[${producto.codigo}] ${producto.nombre}`;
  document.getElementById('adj-stock-actual').textContent = fmt(cantidad_actual);
  document.getElementById('adj-cantidad').value = 1;
  document.getElementById('adj-motivo').value = '';
  selectTipo('entrada');

  // Llenar ubicaciones destino
  const sel = document.getElementById('adj-ub-destino');
  sel.innerHTML = ubicaciones.filter(u => u.id !== ubicacion_id).map(u => `<option value="${u.id}">${u.nombre}</option>`).join('');

  openModal('modal-ajuste');
}

function selectTipo(tipo) {
  tipoAjusteSeleccionado = tipo;
  document.querySelectorAll('.tipo-btn').forEach(b => b.classList.remove('selected'));
  document.querySelector(`.tipo-btn.${tipo}`).classList.add('selected');
  document.getElementById('adj-transfer-row').style.display = tipo === 'transferencia' ? '' : 'none';
}

function changeQty(delta) {
  const el = document.getElementById('adj-cantidad');
  el.value = Math.max(0.001, (parseFloat(el.value) || 0) + delta);
}

async function submitAjuste() {
  const pid = document.getElementById('adj-producto-id').value;
  const uid = document.getElementById('adj-ubicacion-id').value;
  const cantidad = parseFloat(document.getElementById('adj-cantidad').value);
  const motivo = document.getElementById('adj-motivo').value;
  const tipo = tipoAjusteSeleccionado;

  if (!cantidad || cantidad <= 0) return toast('Ingres√° una cantidad v√°lida', 'error');

  try {
    if (tipo === 'transferencia') {
      const ub_destino = document.getElementById('adj-ub-destino').value;
      await apiFetch('/stock/transferencia', { method: 'POST', body: JSON.stringify({ producto_id: pid, ubicacion_origen_id: uid, ubicacion_destino_id: ub_destino, cantidad, motivo, usuario: 'admin' }) });
    } else {
      await apiFetch('/stock/ajuste', { method: 'POST', body: JSON.stringify({ producto_id: pid, ubicacion_id: uid, tipo, cantidad, motivo, usuario: 'admin' }) });
    }
    toast('Stock actualizado correctamente');
    closeModal('modal-ajuste');
    if (currentSection === 'stock') loadStock();
    else if (currentSection === 'alertas') loadAlertas();
    else if (currentSection === 'dashboard') loadDashboard();
  } catch (e) {}
}

// ===================== PRODUCTOS =====================
async function loadProductos() {
  const search = document.getElementById('prod-search').value;
  const cat = document.getElementById('prod-filter-cat').value;
  let params = new URLSearchParams();
  if (search) params.append('search', search);
  if (cat) params.append('categoria_id', cat);
  try {
    const data = await apiFetch('/productos?' + params);
    const tbody = document.getElementById('prod-tbody');
    if (!data.length) { tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div>üè∑</div><p>No hay productos</p></div></td></tr>`; return; }
    tbody.innerHTML = data.map(p => `<tr>
      <td class="mono">${p.codigo}</td>
      <td><strong>${p.nombre}</strong>${p.descripcion ? `<br><small style="color:var(--text-muted)">${p.descripcion.substring(0,60)}</small>` : ''}</td>
      <td>${p.categoria || '‚Äî'}</td>
      <td>${p.unidad_medida}</td>
      <td class="mono">${fmtMoney(p.precio_costo)}</td>
      <td class="mono">${fmt(p.stock_total)}</td>
      <td style="display:flex;gap:6px">
        <button class="btn btn-icon btn-sm" onclick='editProducto(${JSON.stringify(p)})' title="Editar">‚úè</button>
        <button class="btn btn-danger btn-sm" onclick="deleteProducto(${p.id})">üóë</button>
      </td>
    </tr>`).join('');
  } catch (e) {}
}

function openModalProducto() {
  document.getElementById('prod-id').value = '';
  document.getElementById('prod-codigo').value = '';
  document.getElementById('prod-nombre').value = '';
  document.getElementById('prod-desc').value = '';
  document.getElementById('prod-unidad').value = 'unidad';
  document.getElementById('prod-precio').value = '';
  document.getElementById('modal-prod-title').textContent = 'Nuevo Producto';
  fillCatSelect('prod-cat');
  openModal('modal-producto');
}

function editProducto(p) {
  document.getElementById('prod-id').value = p.id;
  document.getElementById('prod-codigo').value = p.codigo;
  document.getElementById('prod-nombre').value = p.nombre;
  document.getElementById('prod-desc').value = p.descripcion || '';
  document.getElementById('prod-unidad').value = p.unidad_medida;
  document.getElementById('prod-precio').value = p.precio_costo;
  document.getElementById('modal-prod-title').textContent = 'Editar Producto';
  fillCatSelect('prod-cat', p.categoria_id);
  openModal('modal-producto');
}

async function submitProducto() {
  const id = document.getElementById('prod-id').value;
  const body = {
    codigo: document.getElementById('prod-codigo').value,
    nombre: document.getElementById('prod-nombre').value,
    descripcion: document.getElementById('prod-desc').value,
    categoria_id: document.getElementById('prod-cat').value || null,
    unidad_medida: document.getElementById('prod-unidad').value || 'unidad',
    precio_costo: parseFloat(document.getElementById('prod-precio').value) || 0
  };
  if (!body.codigo || !body.nombre) return toast('C√≥digo y nombre son obligatorios', 'error');
  try {
    if (id) await apiFetch(`/productos/${id}`, { method: 'PUT', body: JSON.stringify(body) });
    else await apiFetch('/productos', { method: 'POST', body: JSON.stringify(body) });
    toast(id ? 'Producto actualizado' : 'Producto creado');
    closeModal('modal-producto');
    loadProductos();
  } catch (e) {}
}

async function deleteProducto(id) {
  if (!confirm('¬øEliminar este producto? Se eliminar√° su stock asociado.')) return;
  try { await apiFetch(`/productos/${id}`, { method: 'DELETE' }); toast('Producto eliminado'); loadProductos(); } catch (e) {}
}

// ===================== UBICACIONES =====================
async function loadUbicaciones() {
  try {
    const data = await apiFetch('/ubicaciones');
    ubicaciones = data;
    fillUbicacionesSelects();
    const tbody = document.getElementById('ub-tbody');
    if (!data.length) { tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div>üìç</div><p>No hay ubicaciones</p></div></td></tr>`; return; }
    tbody.innerHTML = data.map(u => `<tr>
      <td><strong>${u.nombre}</strong></td>
      <td style="color:var(--text-muted)">${u.descripcion || '‚Äî'}</td>
      <td class="mono">${u.total_productos}</td>
      <td class="mono">${fmt(u.stock_total)}</td>
      <td style="display:flex;gap:6px">
        <button class="btn btn-icon btn-sm" onclick='editUbicacion(${JSON.stringify(u)})'>‚úè</button>
        <button class="btn btn-danger btn-sm" onclick="deleteUbicacion(${u.id})">üóë</button>
      </td>
    </tr>`).join('');
  } catch (e) {}
}

function openModalUbicacion() {
  document.getElementById('ub-id').value = '';
  document.getElementById('ub-nombre').value = '';
  document.getElementById('ub-desc').value = '';
  document.getElementById('modal-ub-title').textContent = 'Nueva Ubicaci√≥n';
  openModal('modal-ubicacion');
}

function editUbicacion(u) {
  document.getElementById('ub-id').value = u.id;
  document.getElementById('ub-nombre').value = u.nombre;
  document.getElementById('ub-desc').value = u.descripcion || '';
  document.getElementById('modal-ub-title').textContent = 'Editar Ubicaci√≥n';
  openModal('modal-ubicacion');
}

async function submitUbicacion() {
  const id = document.getElementById('ub-id').value;
  const body = { nombre: document.getElementById('ub-nombre').value, descripcion: document.getElementById('ub-desc').value };
  if (!body.nombre) return toast('El nombre es obligatorio', 'error');
  try {
    if (id) await apiFetch(`/ubicaciones/${id}`, { method: 'PUT', body: JSON.stringify(body) });
    else await apiFetch('/ubicaciones', { method: 'POST', body: JSON.stringify(body) });
    toast(id ? 'Ubicaci√≥n actualizada' : 'Ubicaci√≥n creada');
    closeModal('modal-ubicacion');
    loadUbicaciones();
  } catch (e) {}
}

async function deleteUbicacion(id) {
  if (!confirm('¬øEliminar esta ubicaci√≥n?')) return;
  try { await apiFetch(`/ubicaciones/${id}`, { method: 'DELETE' }); toast('Ubicaci√≥n eliminada'); loadUbicaciones(); } catch (e) {}
}

// ===================== CATEGOR√çAS =====================
async function loadCategorias() {
  try {
    const data = await apiFetch('/categorias');
    categorias = data;
    const tbody = document.getElementById('cat-tbody');
    if (!data.length) { tbody.innerHTML = `<tr><td colspan="3"><div class="empty-state"><div>üóÇ</div><p>No hay categor√≠as</p></div></td></tr>`; return; }
    tbody.innerHTML = data.map(c => `<tr>
      <td><strong>${c.nombre}</strong></td>
      <td class="mono">${c.total_productos}</td>
      <td style="display:flex;gap:6px">
        <button class="btn btn-icon btn-sm" onclick='editCategoria(${JSON.stringify(c)})'>‚úè</button>
        <button class="btn btn-danger btn-sm" onclick="deleteCategoria(${c.id})">üóë</button>
      </td>
    </tr>`).join('');
  } catch (e) {}
}

function openModalCategoria() {
  document.getElementById('cat-id').value = '';
  document.getElementById('cat-nombre').value = '';
  document.getElementById('modal-cat-title').textContent = 'Nueva Categor√≠a';
  openModal('modal-categoria');
}
function editCategoria(c) {
  document.getElementById('cat-id').value = c.id;
  document.getElementById('cat-nombre').value = c.nombre;
  document.getElementById('modal-cat-title').textContent = 'Editar Categor√≠a';
  openModal('modal-categoria');
}
async function submitCategoria() {
  const id = document.getElementById('cat-id').value;
  const body = { nombre: document.getElementById('cat-nombre').value };
  if (!body.nombre) return toast('El nombre es obligatorio', 'error');
  try {
    if (id) await apiFetch(`/categorias/${id}`, { method: 'PUT', body: JSON.stringify(body) });
    else await apiFetch('/categorias', { method: 'POST', body: JSON.stringify(body) });
    toast(id ? 'Categor√≠a actualizada' : 'Categor√≠a creada');
    closeModal('modal-categoria');
    loadCategorias();
  } catch (e) {}
}
async function deleteCategoria(id) {
  if (!confirm('¬øEliminar esta categor√≠a?')) return;
  try { await apiFetch(`/categorias/${id}`, { method: 'DELETE' }); toast('Categor√≠a eliminada'); loadCategorias(); } catch (e) {}
}

// ===================== MOVIMIENTOS =====================
async function loadMovimientos() {
  const tipo = document.getElementById('mov-tipo').value;
  const ub = document.getElementById('mov-ub').value;
  const desde = document.getElementById('mov-desde').value;
  const hasta = document.getElementById('mov-hasta').value;
  let params = new URLSearchParams({ limit: 200 });
  if (tipo) params.append('tipo', tipo);
  if (ub) params.append('ubicacion_id', ub);
  if (desde) params.append('desde', desde);
  if (hasta) params.append('hasta', hasta);
  try {
    const data = await apiFetch('/movimientos?' + params);
    const tbody = document.getElementById('mov-tbody');
    if (!data.length) { tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div>üîÑ</div><p>Sin movimientos</p></div></td></tr>`; return; }
    tbody.innerHTML = data.map(m => `<tr>
      <td class="mono" style="white-space:nowrap;font-size:12px">${new Date(m.creado_en).toLocaleString('es-AR')}</td>
      <td><span class="pill pill-${m.tipo}">${m.tipo.toUpperCase()}</span></td>
      <td><strong>${m.producto}</strong><br><span class="mono" style="font-size:11px;color:var(--text-muted)">${m.codigo}</span></td>
      <td>${m.ubicacion}</td>
      <td class="mono">${fmt(m.cantidad)}</td>
      <td class="mono" style="color:var(--text-muted)">${fmt(m.cantidad_anterior)}</td>
      <td class="mono">${fmt(m.cantidad_posterior)}</td>
      <td style="color:var(--text-muted);font-size:12px">${m.motivo || '‚Äî'}</td>
      <td style="font-size:12px">${m.usuario || 'admin'}</td>
    </tr>`).join('');
  } catch (e) {}
}

// ===================== REPORTES =====================
async function loadReporteOptions() {
  const selUb = document.getElementById('rep-ub');
  selUb.innerHTML = '<option value="">Todas las ubicaciones</option>' + ubicaciones.map(u => `<option value="${u.id}">${u.nombre}</option>`).join('');

  // Default fechas
  const hoy = new Date().toISOString().split('T')[0];
  const hace30 = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
  document.getElementById('rep-desde').value = hace30;
  document.getElementById('rep-hasta').value = hoy;
}

function downloadReporte(tipo) {
  let url = `${API}/reportes/${tipo}`;
  const params = new URLSearchParams();
  if (tipo === 'stock-general') {
    const ub = document.getElementById('rep-ub').value;
    if (ub) params.append('ubicacion_id', ub);
  } else if (tipo === 'movimientos') {
    const desde = document.getElementById('rep-desde').value;
    const hasta = document.getElementById('rep-hasta').value;
    if (desde) params.append('desde', desde);
    if (hasta) params.append('hasta', hasta);
  }
  if ([...params].length) url += '?' + params;
  window.open(url, '_blank');
  toast('Descargando reporte Excel...');
}

// ===================== HELPERS =====================
function fillCatSelect(elId, selectedId = null) {
  const el = document.getElementById(elId);
  el.innerHTML = '<option value="">Sin categor√≠a</option>' + categorias.map(c =>
    `<option value="${c.id}" ${c.id == selectedId ? 'selected' : ''}>${c.nombre}</option>`).join('');
}

function fillUbicacionesSelects() {
  ['stock-filter-ub', 'mov-ub'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const val = el.value;
    el.innerHTML = `<option value="">${id === 'stock-filter-ub' ? 'Todas las ubicaciones' : 'Todas las ubicaciones'}</option>` +
      ubicaciones.map(u => `<option value="${u.id}">${u.nombre}</option>`).join('');
    el.value = val;
  });
}

// ===================== INIT =====================
async function init() {
  try {
    [ubicaciones, categorias] = await Promise.all([apiFetch('/ubicaciones'), apiFetch('/categorias')]);
    fillUbicacionesSelects();
    loadDashboard();
  } catch (e) {
    toast('No se pudo conectar con el servidor. Verific√° que est√© corriendo en localhost:3001', 'error');
  }
}

// Cerrar modal al click fuera
document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', (e) => { if (e.target === el) el.classList.remove('open'); });
});

init();
</script>
</body>
</html>
